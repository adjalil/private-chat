<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrivateLink â€” P2P Call</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg: #0d0d0f;
    --surface: #16161a;
    --surface2: #1e1e24;
    --border: #2a2a35;
    --accent: #7c6aff;
    --accent2: #ff6a9a;
    --green: #4ade80;
    --red: #f87171;
    --text: #e8e8f0;
    --muted: #6b6b80;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Subtle grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(124,106,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(124,106,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    background: rgba(22,22,26,0.9);
    backdrop-filter: blur(10px);
    position: relative;
    z-index: 10;
  }

  .logo {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 1.1rem;
    letter-spacing: -0.5px;
  }
  .logo span { color: var(--accent); }

  .status-pill {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
    transition: all 0.3s;
  }
  .status-pill.connected { border-color: var(--green); color: var(--green); background: rgba(74,222,128,0.08); }
  .status-pill.connecting { border-color: var(--accent); color: var(--accent); animation: pulse 1.5s infinite; }
  .status-pill.error { border-color: var(--red); color: var(--red); }

  @keyframes pulse { 0%,100% { opacity:1 } 50% { opacity:0.5 } }

  /* â”€â”€ Main layout â”€â”€ */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
    z-index: 1;
  }

  /* â”€â”€ Setup Panel â”€â”€ */
  .setup-panel {
    width: 360px;
    min-width: 320px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 24px;
    gap: 20px;
    overflow-y: auto;
  }

  .section-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .room-id-display {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .room-id-display code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.1rem;
    color: var(--accent);
    flex: 1;
    letter-spacing: 3px;
  }

  .copy-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  .copy-btn.copied { border-color: var(--green); color: var(--green); }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--muted);
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
  }
  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .join-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  input[type="text"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 1rem;
    letter-spacing: 3px;
    width: 100%;
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type="text"]::placeholder { color: var(--muted); letter-spacing: 1px; font-size: 0.85rem; }
  input[type="text"]:focus { border-color: var(--accent); }

  button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }
  .btn-primary:hover { background: #6a58e8; transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .btn-danger {
    background: rgba(248,113,113,0.1);
    color: var(--red);
    border: 1px solid rgba(248,113,113,0.3);
  }
  .btn-danger:hover { background: rgba(248,113,113,0.2); }

  .btn-icon {
    width: 40px;
    height: 40px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 1rem;
  }

  /* Controls */
  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .control-btn {
    flex: 1;
    min-width: 80px;
    padding: 10px 8px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
  }
  .control-btn:hover { border-color: var(--accent); }
  .control-btn.active { background: rgba(124,106,255,0.15); border-color: var(--accent); color: var(--accent); }
  .control-btn.muted { background: rgba(248,113,113,0.1); border-color: var(--red); color: var(--red); }

  /* â”€â”€ Video area â”€â”€ */
  .video-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .videos {
    display: flex;
    gap: 12px;
    padding: 16px;
    height: 40%;
    min-height: 180px;
    background: #0a0a0c;
  }

  video {
    flex: 1;
    border-radius: 12px;
    background: #111;
    object-fit: cover;
    border: 1px solid var(--border);
    position: relative;
  }

  .video-wrapper {
    flex: 1;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: #111;
  }

  .video-wrapper video { width: 100%; height: 100%; border: none; border-radius: 0; }

  .video-label {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    color: white;
    background: rgba(0,0,0,0.6);
    padding: 3px 8px;
    border-radius: 4px;
  }

  .video-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--muted);
  }

  .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--surface2);
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  /* â”€â”€ Chat â”€â”€ */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-top: 1px solid var(--border);
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .msg {
    display: flex;
    flex-direction: column;
    max-width: 75%;
    animation: msgIn 0.2s ease;
  }
  @keyframes msgIn { from { opacity:0; transform: translateY(4px) } }

  .msg.me { align-self: flex-end; align-items: flex-end; }
  .msg.them { align-self: flex-start; }
  .msg.system { align-self: center; align-items: center; }

  .msg-bubble {
    padding: 8px 14px;
    border-radius: 16px;
    font-size: 0.9rem;
    line-height: 1.4;
  }
  .msg.me .msg-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
  .msg.them .msg-bubble { background: var(--surface2); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .msg.system .msg-bubble {
    background: transparent;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 4px 12px;
  }

  .msg-name {
    font-size: 0.7rem;
    color: var(--muted);
    margin-bottom: 3px;
    font-family: 'JetBrains Mono', monospace;
  }

  .chat-input-row {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    background: var(--surface);
  }

  .chat-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 10px 18px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    outline: none;
    letter-spacing: normal;
    text-transform: none;
    transition: border-color 0.2s;
  }
  .chat-input:focus { border-color: var(--accent); }

  .send-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .send-btn:hover { background: #6a58e8; transform: scale(1.05); }

  .info-box {
    background: rgba(124,106,255,0.06);
    border: 1px solid rgba(124,106,255,0.2);
    border-radius: 8px;
    padding: 12px 14px;
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.6;
  }
  .info-box strong { color: var(--text); }

  /* Volume indicator */
  .vol-bar {
    height: 3px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 4px;
  }
  .vol-fill {
    height: 100%;
    background: var(--green);
    width: 0%;
    transition: width 0.1s;
    border-radius: 3px;
  }
</style>
</head>
<body>

<header>
  <div class="logo">Private<span>Link</span></div>
  <div class="status-pill" id="statusPill">â— initializing</div>
</header>

<div class="main">
  <!-- Setup Panel -->
  <div class="setup-panel">

    <div>
      <div class="section-label">Your Room ID</div>
      <div class="room-id-display">
        <code id="myIdDisplay">â€”â€”</code>
        <button class="copy-btn" id="copyBtn" onclick="copyRoomId()">Copy</button>
      </div>
      <div class="vol-bar" style="margin-top:8px"><div class="vol-fill" id="volFill"></div></div>
    </div>

    <div class="divider">or join friend</div>

    <div class="join-group">
      <div class="section-label">Friend's Room ID</div>
      <input type="text" id="friendId" maxlength="8" placeholder="Paste their ID...">
      <button class="btn-primary" onclick="callFriend()">ğŸ“ Call Friend</button>
    </div>

    <div>
      <div class="section-label">Controls</div>
      <div class="controls">
        <button class="control-btn" id="muteBtn" onclick="toggleMute()">ğŸ™ï¸ Mute</button>
        <button class="control-btn" id="screenBtn" onclick="toggleScreen()">ğŸ–¥ï¸ Screen</button>
        <button class="control-btn btn-danger" id="hangBtn" onclick="hangUp()" style="display:none">ğŸ“µ Hang Up</button>
      </div>
    </div>

    <div class="info-box">
      <strong>How it works:</strong><br>
      1. Share your <strong>Room ID</strong> with a friend<br>
      2. They paste it and click <strong>Call</strong><br>
      3. Audio streams directly P2P â€” no servers store your call<br><br>
      <strong>Screen share:</strong> click Screen during a call
    </div>

  </div>

  <!-- Video + Chat -->
  <div class="video-chat">
    <div class="videos">
      <div class="video-wrapper" id="localWrapper">
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="video-placeholder" id="localPlaceholder">
          <div class="avatar">ğŸ™ï¸</div>
          <span style="font-size:0.75rem;color:var(--muted)">You (audio only)</span>
        </div>
        <div class="video-label">You</div>
      </div>
      <div class="video-wrapper" id="remoteWrapper">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="video-placeholder" id="remotePlaceholder">
          <div class="avatar">ğŸ‘¤</div>
          <span style="font-size:0.75rem;color:var(--muted)">Waiting for friendâ€¦</span>
        </div>
        <div class="video-label">Friend</div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-messages" id="chatMessages">
        <div class="msg system"><div class="msg-bubble">End-to-end encrypted Â· Private P2P</div></div>
      </div>
      <div class="chat-input-row">
        <input class="chat-input" type="text" id="chatInput" placeholder="Messageâ€¦" onkeydown="if(event.key==='Enter')sendMsg()">
        <button class="send-btn" onclick="sendMsg()">â¤</button>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let peer, currentCall, dataConn;
let localStream, screenStream;
let isMuted = false;
let isScreenSharing = false;
let isNegotiating = false;

// â”€â”€ Generate random 6-char room ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genId() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:6}, () => chars[Math.floor(Math.random()*chars.length)]).join('');
}

// â”€â”€ Initialize PeerJS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initPeer() {
  const myId = genId();
  document.getElementById('myIdDisplay').textContent = myId;
  setStatus('connecting', 'connectingâ€¦');

  peer = new Peer(myId, {
    host: '0.peerjs.com',
    port: 443,
    secure: true,
    path: '/',
    debug: 0
  });

  peer.on('open', id => {
    setStatus('ready', 'â— ready');
    sysMsg('Your Room ID: ' + id + ' â€” share it!');
    initAudio();
  });

  peer.on('error', e => {
    setStatus('error', 'â— error');
    sysMsg('Connection error: ' + e.type + '. Try refreshing.');
    console.error(e);
  });

  // Incoming call
  peer.on('call', call => {
    sysMsg('Incoming callâ€¦ answeringâ€¦');
    currentCall = call;
    call.answer(localStream);
    handleCallStream(call);
    showHangUp();
  });

  // Incoming data connection
  peer.on('connection', conn => {
    dataConn = conn;
    setupDataConn(conn);
  });
}

// â”€â”€ Audio init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initAudio() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    document.getElementById('localVideo').srcObject = localStream;
    sysMsg('ğŸ™ï¸ Microphone active');
    setupVolumeIndicator();
  } catch(e) {
    sysMsg('âš ï¸ Mic error: ' + e.message);
    setStatus('error', 'â— mic error');
    // Create empty stream so calls can still proceed (screen share only)
    localStream = new MediaStream();
  }
}

// â”€â”€ Volume indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupVolumeIndicator() {
  try {
    const ac = new AudioContext();
    const src = ac.createMediaStreamSource(localStream);
    const analyser = ac.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);
    const fill = document.getElementById('volFill');
    (function tick() {
      analyser.getByteFrequencyData(data);
      const avg = data.reduce((a,b) => a+b) / data.length;
      fill.style.width = Math.min(avg * 2, 100) + '%';
      requestAnimationFrame(tick);
    })();
  } catch(e) {}
}

// â”€â”€ Call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function callFriend() {
  const friendId = document.getElementById('friendId').value.trim().toUpperCase();
  if (!friendId || friendId.length < 4) return sysMsg('âš ï¸ Enter your friend\'s Room ID first');
  if (!localStream) return sysMsg('âš ï¸ Microphone not ready yet');

  sysMsg('ğŸ“ Calling ' + friendId + 'â€¦');
  setStatus('connecting', 'â— callingâ€¦');

  currentCall = peer.call(friendId, localStream);
  handleCallStream(currentCall);
  showHangUp();

  // Data channel for chat
  dataConn = peer.connect(friendId);
  setupDataConn(dataConn);
}

function handleCallStream(call) {
  call.on('stream', remoteStream => {
    setRemoteStream(remoteStream);
    setStatus('connected', 'â— connected');
    sysMsg('âœ… Connected!');
  });

  // Also listen directly on the RTCPeerConnection for new tracks (screen share renegotiation)
  call.peerConnection.ontrack = e => {
    if (e.streams && e.streams[0]) setRemoteStream(e.streams[0]);
  };

  // Handle incoming renegotiation offers/answers sent via data channel
  call.peerConnection.onnegotiationneeded = async () => {
    // Only the side that added the track should send the offer
    // We flag this with isNegotiating to avoid loops
    if (!isNegotiating) return;
    try {
      const offer = await call.peerConnection.createOffer();
      await call.peerConnection.setLocalDescription(offer);
      sendSignal({ type: 'renego-offer', sdp: call.peerConnection.localDescription });
    } catch(e) { console.error('Renegotiation error:', e); }
  };

  call.on('close', () => {
    setStatus('ready', 'â— ready');
    sysMsg('ğŸ“µ Call ended');
    document.getElementById('remoteVideo').srcObject = null;
    document.getElementById('remotePlaceholder').style.display = 'flex';
    document.getElementById('hangBtn').style.display = 'none';
  });

  call.on('error', e => sysMsg('âš ï¸ Call error: ' + e));
}

function setRemoteStream(stream) {
  const vid = document.getElementById('remoteVideo');
  // If already has this stream, skip
  if (vid.srcObject === stream) return;
  vid.srcObject = stream;
  document.getElementById('remotePlaceholder').style.display = 'none';
}

// Send a signaling message to peer via data channel (JSON with __signal flag)
function sendSignal(payload) {
  if (dataConn && dataConn.open) {
    dataConn.send(JSON.stringify({ __signal: true, ...payload }));
  }
}

// Handle incoming signal from peer
async function handleSignal(payload) {
  if (!currentCall) return;
  const pc = currentCall.peerConnection;
  try {
    if (payload.type === 'renego-offer') {
      await pc.setRemoteDescription(new RTCSessionDescription(payload.sdp));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      sendSignal({ type: 'renego-answer', sdp: pc.localDescription });
    } else if (payload.type === 'renego-answer') {
      await pc.setRemoteDescription(new RTCSessionDescription(payload.sdp));
    } else if (payload.type === 'screen-stopped') {
      // Friend stopped their screen share â€” clear the video
      sysMsg('ğŸ–¥ï¸ Friend stopped screen share');
      const vid = document.getElementById('remoteVideo');
      // Remove video tracks from remote stream
      if (vid.srcObject) {
        vid.srcObject.getVideoTracks().forEach(t => t.stop());
        const audioTracks = vid.srcObject.getAudioTracks();
        if (audioTracks.length === 0) {
          vid.srcObject = null;
          document.getElementById('remotePlaceholder').style.display = 'flex';
        }
      }
    }
  } catch(e) { console.error('Signal handling error:', e); }
}

// â”€â”€ Data / Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDataConn(conn) {
  conn.on('open', () => sysMsg('ğŸ’¬ Chat connected'));
  conn.on('data', raw => {
    try {
      const parsed = JSON.parse(raw);
      if (parsed.__signal) { handleSignal(parsed); return; }
    } catch(e) {}
    appendMsg('Friend', raw, 'them');
  });
  conn.on('close', () => sysMsg('ğŸ’¬ Chat disconnected'));
  conn.on('error', e => console.error(e));
}

function sendMsg() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  if (!dataConn || dataConn.open !== true) {
    sysMsg('âš ï¸ Chat not connected yet');
    return;
  }
  dataConn.send(msg);
  appendMsg('You', msg, 'me');
  input.value = '';
}

function appendMsg(name, text, type) {
  const chat = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg ' + type;
  div.innerHTML = (type !== 'system' && type !== 'me' ? `<div class="msg-name">${name}</div>` : '') +
    `<div class="msg-bubble">${escHtml(text)}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function sysMsg(text) {
  appendMsg('', text, 'system');
}

// â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMute() {
  if (!localStream) return;
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
  const btn = document.getElementById('muteBtn');
  btn.textContent = isMuted ? 'ğŸ”‡ Unmute' : 'ğŸ™ï¸ Mute';
  btn.classList.toggle('muted', isMuted);
}

async function toggleScreen() {
  if (isScreenSharing) {
    isNegotiating = true;
    if (screenStream) screenStream.getTracks().forEach(t => t.stop());
    screenStream = null;
    isScreenSharing = false;
    document.getElementById('localVideo').srcObject = localStream;
    document.getElementById('localPlaceholder').style.display = 'flex';
    document.getElementById('screenBtn').textContent = 'ğŸ–¥ï¸ Screen';
    document.getElementById('screenBtn').classList.remove('active');

    // Remove video senders from the peer connection
    if (currentCall) {
      const pc = currentCall.peerConnection;
      pc.getSenders()
        .filter(s => s.track && s.track.kind === 'video')
        .forEach(s => pc.removeTrack(s));
      // Manually renegotiate after removing tracks (onnegotiationneeded may not fire for removes)
      try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendSignal({ type: 'renego-offer', sdp: pc.localDescription });
      } catch(e) { console.error(e); }
    }

    sendSignal({ type: 'screen-stopped' });
    isNegotiating = false;
    return;
  }

  try {
    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
    const videoTrack = screenStream.getVideoTracks()[0];

    document.getElementById('localVideo').srcObject = screenStream;
    document.getElementById('localPlaceholder').style.display = 'none';
    isScreenSharing = true;
    document.getElementById('screenBtn').textContent = 'â¹ Stop';
    document.getElementById('screenBtn').classList.add('active');

    if (currentCall) {
      isNegotiating = true;
      const pc = currentCall.peerConnection;
      // Always add as a new track â€” replaceTrack won't trigger renegotiation
      pc.addTrack(videoTrack, screenStream);
      // onnegotiationneeded will fire and send the offer
    }

    videoTrack.onended = () => { if (isScreenSharing) toggleScreen(); };
  } catch(e) {
    sysMsg('âš ï¸ Screen share failed: ' + e.message);
  }
}

function hangUp() {
  if (currentCall) { currentCall.close(); currentCall = null; }
  if (dataConn) { dataConn.close(); dataConn = null; }
  document.getElementById('hangBtn').style.display = 'none';
  setStatus('ready', 'â— ready');
  sysMsg('ğŸ“µ You hung up');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyRoomId() {
  const id = document.getElementById('myIdDisplay').textContent;
  if (id === 'â€”â€”') return;
  navigator.clipboard.writeText(id).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = 'âœ“ Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function setStatus(cls, text) {
  const pill = document.getElementById('statusPill');
  pill.className = 'status-pill ' + cls;
  pill.textContent = text;
}

function showHangUp() {
  document.getElementById('hangBtn').style.display = 'flex';
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initPeer();
</script>
</body>
</html>
