<!DOCTYPE html>
<html>
<head>
    <title>Private 2-Person Link</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        video { width: 45%; border: 2px solid #5865f2; border-radius: 8px; margin: 10px; background: black; }
        textarea { width: 90%; height: 100px; background: #2f3136; color: #dcddde; border: none; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; background: #5865f2; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .chat-box { width: 90%; height: 150px; overflow-y: scroll; background: #2f3136; padding: 10px; margin-top: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <h2>Private P2P Voice, Video & Screen</h2>
    
    <div style="display:flex; justify-content:center; width: 100%;">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div>
        <button onclick="startCall()">1. Generate My Link</button>
        <button onclick="answerCall()">2. Paste Friend's Link & Connect</button>
        <button onclick="shareScreen()">Share Screen</button>
    </div>

    <p>Step 1: Copy this and send to friend:</p>
    <textarea id="offerText" readonly placeholder="Click 'Generate' to see your link..."></textarea>
    
    <p>Step 2: Paste friend's link here:</p>
    <textarea id="answerText" placeholder="Paste your friend's code here..."></textarea>

    <div class="chat-box" id="chat"><b>System:</b> Waiting for connection...</div>
    <input type="text" id="msgInput" placeholder="Type a message..." style="width:80%; padding:10px; margin-top:10px;">
    <button onclick="sendMessage()">Send</button>

    <script>
    let localStream;
    let peerConnection;
    let dataChannel;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    function updateStatus(msg) {
        document.getElementById('chat').innerHTML += `<br><i style="color:yellow">Status: ${msg}</i>`;
        console.log(msg);
    }

    async function init() {
        updateStatus("Requesting Camera/Mic...");
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            updateStatus("Camera/Mic active.");
        } catch (e) {
            updateStatus("ERROR: " + e.message);
        }
    }

    async function startCall() {
        if (!localStream) await init();
        
        updateStatus("Creating Peer Connection...");
        peerConnection = new RTCPeerConnection(config);
        
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        dataChannel = peerConnection.createDataChannel("chat");
        setupDataChannel();

        // This creates the 'Link' text
        peerConnection.onicecandidate = e => {
            if (e.candidate) {
                updateStatus("Finding network path...");
            } else {
                updateStatus("Link generation complete!");
            }
            // Update the box every time a new path is found
            document.getElementById('offerText').value = JSON.stringify(peerConnection.localDescription);
        };

        peerConnection.ontrack = e => {
            updateStatus("Remote video received!");
            document.getElementById('remoteVideo').srcObject = e.streams[0];
        };

        updateStatus("Creating Offer...");
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        document.getElementById('offerText').value = JSON.stringify(peerConnection.localDescription);
    }

    async function answerCall() {
        const input = document.getElementById('answerText').value;
        if (!input) return alert("Paste your friend's code first!");
        
        const remoteData = JSON.parse(input);
        
        if (!peerConnection) { 
            await init();
            peerConnection = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            peerConnection.onicecandidate = e => {
                document.getElementById('offerText').value = JSON.stringify(peerConnection.localDescription);
            };
            
            peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
            peerConnection.ondatachannel = e => { dataChannel = e.channel; setupDataChannel(); };
            
            updateStatus("Setting remote description...");
            await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteData));
            updateStatus("Creating Answer...");
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
        } else {
            updateStatus("Finalizing connection...");
            await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteData));
        }
    }

    function setupDataChannel() {
        dataChannel.onopen = () => updateStatus("CHAT CONNECTED!");
        dataChannel.onmessage = e => appendChat("Friend", e.data);
    }

    function sendMessage() {
        const msg = document.getElementById('msgInput').value;
        if (dataChannel && dataChannel.readyState === "open") {
            dataChannel.send(msg);
            appendChat("Me", msg);
            document.getElementById('msgInput').value = "";
        }
    }

    function appendChat(user, msg) {
        document.getElementById('chat').innerHTML += `<br><b>${user}:</b> ${msg}`;
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    async function shareScreen() {
        updateStatus("Requesting Screen Share...");
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const videoTrack = screenStream.getVideoTracks()[0];
        const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
        sender.replaceTrack(videoTrack);
        document.getElementById('localVideo').srcObject = screenStream;
    }
</script>
</body>
</html>
