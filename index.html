<!DOCTYPE html>
<html>
<head>
    <title>Private 2-Person Link</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        video { width: 45%; border: 2px solid #5865f2; border-radius: 8px; margin: 10px; background: black; }
        textarea { width: 90%; height: 100px; background: #2f3136; color: #dcddde; border: none; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; background: #5865f2; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .chat-box { width: 90%; height: 150px; overflow-y: scroll; background: #2f3136; padding: 10px; margin-top: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <h2>Private P2P Voice, Video & Screen</h2>
    
    <div style="display:flex; justify-content:center; width: 100%;">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div>
        <button onclick="startCall()">1. Generate My Link</button>
        <button onclick="answerCall()">2. Paste Friend's Link & Connect</button>
        <button onclick="shareScreen()">Share Screen</button>
    </div>

    <p>Step 1: Copy this and send to friend:</p>
    <textarea id="offerText" readonly placeholder="Click 'Generate' to see your link..."></textarea>
    
    <p>Step 2: Paste friend's link here:</p>
    <textarea id="answerText" placeholder="Paste your friend's code here..."></textarea>

    <div class="chat-box" id="chat"><b>System:</b> Waiting for connection...</div>
    <input type="text" id="msgInput" placeholder="Type a message..." style="width:80%; padding:10px; margin-top:10px;">
    <button onclick="sendMessage()">Send</button>

    <script>
    let localStream;
    let peerConnection;
    let dataChannel;
    // STUN servers help peers find each other behind firewalls
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    function updateStatus(msg) {
        document.getElementById('chat').innerHTML += `<br><i style="color:yellow">Status: ${msg}</i>`;
        console.log(msg);
    }

    async function init() {
        updateStatus("Requesting Microphone (Audio Only)...");
        try {
            // We set video: false because you don't have a camera
            localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
            updateStatus("Microphone active.");
            
            // Even though there is no video, we attach the stream to hear yourself test
            document.getElementById('localVideo').srcObject = localStream;
        } catch (e) {
            updateStatus("CRITICAL ERROR: " + e.message);
            alert("Mic error: " + e.message + ". Ensure your mic is plugged in.");
        }
    }

    async function startCall() {
        if (!localStream) await init();
        
        updateStatus("Creating Connection...");
        peerConnection = new RTCPeerConnection(config);
        
        // Add only the audio track
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Setup Chat
        dataChannel = peerConnection.createDataChannel("chat");
        setupDataChannel();

        peerConnection.onicecandidate = e => {
            if (e.candidate) {
                updateStatus("Building connection link...");
            } else {
                updateStatus("Link ready! Copy the code below.");
            }
            document.getElementById('offerText').value = JSON.stringify(peerConnection.localDescription);
        };

        // When your friend sends audio or screen share
        peerConnection.ontrack = e => {
            updateStatus("Friend connected! Audio/Video started.");
            document.getElementById('remoteVideo').srcObject = e.streams[0];
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        document.getElementById('offerText').value = JSON.stringify(peerConnection.localDescription);
    }

    async function answerCall() {
        const input = document.getElementById('answerText').value;
        if (!input) return alert("Paste your friend's code first!");
        
        const remoteData = JSON.parse(input);
        
        if (!peerConnection) { 
            await init();
            peerConnection = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            peerConnection.onicecandidate = e => {
                document.getElementById('offerText').value = JSON.stringify(peerConnection.localDescription);
            };
            
            peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
            peerConnection.ondatachannel = e => { dataChannel = e.channel; setupDataChannel(); };
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteData));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            updateStatus("Answer generated. Send this back to your friend.");
        } else {
            updateStatus("Connecting...");
            await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteData));
        }
    }

    function setupDataChannel() {
        dataChannel.onopen = () => updateStatus("CHAT CONNECTED!");
        dataChannel.onmessage = e => appendChat("Friend", e.data);
    }

    function sendMessage() {
        const msg = document.getElementById('msgInput').value;
        if (dataChannel && dataChannel.readyState === "open") {
            dataChannel.send(msg);
            appendChat("Me", msg);
            document.getElementById('msgInput').value = "";
        }
    }

    function appendChat(user, msg) {
        const chat = document.getElementById('chat');
        chat.innerHTML += `<br><b>${user}:</b> ${msg}`;
        chat.scrollTop = chat.scrollHeight;
    }

    async function shareScreen() {
        updateStatus("Requesting Screen...");
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const videoTrack = screenStream.getVideoTracks()[0];
            
            // Replace the "empty" video with the screen track
            const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender) {
                sender.replaceTrack(videoTrack);
            } else {
                // If we didn't have a video track, add it now
                peerConnection.addTrack(videoTrack, screenStream);
                // Note: Adding a track after connection requires a "re-negotiation"
                // For simplicity, it's best to start screen share before clicking Generate.
            }
            document.getElementById('localVideo').srcObject = screenStream;
            updateStatus("Screen sharing active.");
        } catch (e) {
            updateStatus("Screen share failed: " + e.message);
        }
    }
</script>
</body>
</html>
