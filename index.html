<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrivateLink — P2P Call</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg: #0d0d0f;
    --surface: #16161a;
    --surface2: #1e1e24;
    --border: #2a2a35;
    --accent: #7c6aff;
    --green: #4ade80;
    --red: #f87171;
    --text: #e8e8f0;
    --muted: #6b6b80;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(124,106,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(124,106,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    background: rgba(22,22,26,0.9);
    backdrop-filter: blur(10px);
    position: relative;
    z-index: 10;
  }

  .logo { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.1rem; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }

  .status-pill {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
    transition: all 0.3s;
  }
  .status-pill.connected  { border-color: var(--green); color: var(--green); background: rgba(74,222,128,0.08); }
  .status-pill.connecting { border-color: var(--accent); color: var(--accent); animation: pulse 1.5s infinite; }
  .status-pill.error      { border-color: var(--red); color: var(--red); }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.5} }

  .main { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 1; }

  .setup-panel {
    width: 360px;
    min-width: 320px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 24px;
    gap: 20px;
    overflow-y: auto;
  }

  .section-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .room-id-display {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .room-id-display code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.1rem;
    color: var(--accent);
    flex: 1;
    letter-spacing: 3px;
  }

  .copy-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .copy-btn:hover  { border-color: var(--accent); color: var(--accent); }
  .copy-btn.copied { border-color: var(--green); color: var(--green); }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--muted);
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
  }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .join-group { display: flex; flex-direction: column; gap: 8px; }

  input[type="text"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 1rem;
    letter-spacing: 3px;
    width: 100%;
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type="text"]::placeholder { color: var(--muted); letter-spacing: 1px; font-size: 0.85rem; }
  input[type="text"]:focus { border-color: var(--accent); }

  button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #6a58e8; transform: translateY(-1px); }

  .controls { display: flex; gap: 8px; flex-wrap: wrap; }

  .control-btn {
    flex: 1;
    min-width: 80px;
    padding: 10px 8px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
  }
  .control-btn:hover      { border-color: var(--accent); }
  .control-btn.active     { background: rgba(124,106,255,0.15); border-color: var(--accent); color: var(--accent); }
  .control-btn.muted      { background: rgba(248,113,113,0.1); border-color: var(--red); color: var(--red); }
  .control-btn.btn-danger { background: rgba(248,113,113,0.1); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .control-btn.btn-danger:hover { background: rgba(248,113,113,0.2); }

  .video-chat { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  .videos {
    display: flex;
    gap: 12px;
    padding: 16px;
    height: 40%;
    min-height: 180px;
    background: #0a0a0c;
  }

  .video-wrapper {
    flex: 1;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: #111;
    cursor: pointer;
  }

  .video-wrapper video { width: 100%; height: 100%; border: none; border-radius: 0; object-fit: contain; }

  .video-label {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    color: white;
    background: rgba(0,0,0,0.6);
    padding: 3px 8px;
    border-radius: 4px;
  }

  .fs-hint {
    position: absolute;
    bottom: 10px;
    right: 10px;
    font-size: 0.6rem;
    color: rgba(255,255,255,0.3);
    font-family: 'JetBrains Mono', monospace;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .video-wrapper:hover .fs-hint { opacity: 1; }

  .video-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: var(--muted);
  }

  .avatar {
    width: 60px; height: 60px; border-radius: 50%;
    background: var(--surface2); border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
  }

  .video-wrapper:fullscreen,
  .video-wrapper:-webkit-full-screen { background: black; border: none; border-radius: 0; }
  .video-wrapper:fullscreen video,
  .video-wrapper:-webkit-full-screen video { width: 100%; height: 100%; object-fit: contain; }

  .chat-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; border-top: 1px solid var(--border); }

  .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
  .chat-messages::-webkit-scrollbar       { width: 4px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .msg { display: flex; flex-direction: column; max-width: 75%; animation: msgIn 0.2s ease; }
  @keyframes msgIn { from{opacity:0;transform:translateY(4px)} }
  .msg.me     { align-self: flex-end; align-items: flex-end; }
  .msg.them   { align-self: flex-start; }
  .msg.system { align-self: center; align-items: center; }

  .msg-bubble { padding: 8px 14px; border-radius: 16px; font-size: 0.9rem; line-height: 1.4; }
  .msg.me   .msg-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
  .msg.them .msg-bubble { background: var(--surface2); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .msg.system .msg-bubble {
    background: transparent; color: var(--muted);
    font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
    border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px;
  }

  .msg-name { font-size: 0.7rem; color: var(--muted); margin-bottom: 3px; font-family: 'JetBrains Mono', monospace; }

  .chat-input-row {
    display: flex; gap: 8px; padding: 12px 16px;
    border-top: 1px solid var(--border); background: var(--surface);
  }

  .chat-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 24px; padding: 10px 18px; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem; outline: none;
    letter-spacing: normal; text-transform: none; transition: border-color 0.2s;
  }
  .chat-input:focus { border-color: var(--accent); }

  .send-btn {
    width: 40px; height: 40px; border-radius: 50%; background: var(--accent);
    color: white; border: none; cursor: pointer; font-size: 1rem;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s;
  }
  .send-btn:hover { background: #6a58e8; transform: scale(1.05); }

  .info-box {
    background: rgba(124,106,255,0.06); border: 1px solid rgba(124,106,255,0.2);
    border-radius: 8px; padding: 12px 14px; font-size: 0.8rem; color: var(--muted); line-height: 1.6;
  }
  .info-box strong { color: var(--text); }

  .vol-bar  { height: 3px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 4px; }
  .vol-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.1s; border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="logo">Private<span>Link</span></div>
  <div class="status-pill" id="statusPill">&#9679; initializing</div>
</header>

<div class="main">
  <div class="setup-panel">

    <div>
      <div class="section-label">Your Room ID</div>
      <div class="room-id-display">
        <code id="myIdDisplay">——</code>
        <button class="copy-btn" id="copyBtn" onclick="copyRoomId()">Copy</button>
      </div>
      <div class="vol-bar" style="margin-top:8px"><div class="vol-fill" id="volFill"></div></div>
    </div>

    <div class="divider">or join friend</div>

    <div class="join-group">
      <div class="section-label">Friend's Room ID</div>
      <input type="text" id="friendId" maxlength="6" placeholder="Paste their ID...">
      <button class="btn-primary" onclick="callFriend()">&#128222; Call Friend</button>
    </div>

    <div>
      <div class="section-label">Controls</div>
      <div class="controls">
        <button class="control-btn" id="muteBtn" onclick="toggleMute()">&#127897; Mute</button>
        <button class="control-btn" id="screenBtn" onclick="toggleScreen()">&#128421; Screen</button>
        <button class="control-btn btn-danger" id="hangBtn" onclick="hangUp()" style="display:none">&#128245; Hang Up</button>
      </div>
    </div>

    <div class="info-box">
      <strong>How it works:</strong><br>
      1. Share your <strong>Room ID</strong> with a friend<br>
      2. They paste it and click <strong>Call</strong><br>
      3. Audio streams directly P2P — no servers store your call<br><br>
      <strong>Screen + audio:</strong> check "Share audio" in the browser dialog to let your friend hear tab/system audio.<br><br>
      <strong>Double-click</strong> any video to go fullscreen.
    </div>

  </div>

  <div class="video-chat">
    <div class="videos">
      <div class="video-wrapper" id="localWrapper">
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="video-placeholder" id="localPlaceholder">
          <div class="avatar">&#127897;</div>
          <span style="font-size:0.75rem;color:var(--muted)">You (audio only)</span>
        </div>
        <div class="video-label">You</div>
        <div class="fs-hint">dblclick fullscreen</div>
      </div>
      <div class="video-wrapper" id="remoteWrapper">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="video-placeholder" id="remotePlaceholder">
          <div class="avatar">&#128100;</div>
          <span style="font-size:0.75rem;color:var(--muted)">Waiting for friend...</span>
        </div>
        <div class="video-label">Friend</div>
        <div class="fs-hint">dblclick fullscreen</div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-messages" id="chatMessages">
        <div class="msg system"><div class="msg-bubble">End-to-end encrypted &middot; Private P2P</div></div>
      </div>
      <div class="chat-input-row">
        <input class="chat-input" type="text" id="chatInput" placeholder="Message..." onkeydown="if(event.key==='Enter')sendMsg()">
        <button class="send-btn" onclick="sendMsg()">&#10148;</button>
      </div>
    </div>
  </div>
</div>

<script>
// ── State ────────────────────────────────────────────────────────────
var peer, currentCall, dataConn;
var localStream, screenStream;
var audioCtx, mixerDest, micGainNode;
var isMuted = false;
var isScreenSharing = false;
var isNegotiating = false;

// ── Random 6-char Room ID ────────────────────────────────────────────
function genId() {
  var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  var id = '';
  for (var i = 0; i < 6; i++) id += chars[Math.floor(Math.random() * chars.length)];
  return id;
}

// ── PeerJS init ──────────────────────────────────────────────────────
function initPeer() {
  var myId = genId();
  document.getElementById('myIdDisplay').textContent = myId;
  setStatus('connecting', 'connecting...');

  peer = new Peer(myId, {
    host: '0.peerjs.com',
    port: 443,
    secure: true,
    path: '/',
    debug: 0,
    config: {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    }
  });

  peer.on('open', function(id) {
    setStatus('ready', 'ready');
    sysMsg('Your Room ID: ' + id + ' — share it!');
    initAudio();
  });

  peer.on('error', function(e) {
    setStatus('error', 'error');
    sysMsg('Connection error: ' + e.type + '. Try refreshing.');
    console.error(e);
  });

  peer.on('call', function(call) {
    sysMsg('Incoming call... answering...');
    currentCall = call;
    call.answer(localStream);
    handleCallStream(call);
    showHangUp();
  });

  peer.on('connection', function(conn) {
    dataConn = conn;
    setupDataConn(conn);
  });
}

// ── High-quality mic audio ───────────────────────────────────────────
function initAudio() {
  navigator.mediaDevices.getUserMedia({
    video: false,
    audio: {
      echoCancellation: true,
      noiseSuppression: true,
      autoGainControl: true,
      sampleRate: 48000,
      sampleSize: 16,
      channelCount: 1
    }
  }).then(function(stream) {
    localStream = stream;
    document.getElementById('localVideo').srcObject = stream;
    sysMsg('Microphone active (HD audio)');
    setupVolumeIndicator();
  }).catch(function(e) {
    sysMsg('Mic error: ' + e.message);
    setStatus('error', 'mic error');
    localStream = new MediaStream();
  });
}

// ── Volume bar ───────────────────────────────────────────────────────
function setupVolumeIndicator() {
  try {
    var ac = new AudioContext();
    var src = ac.createMediaStreamSource(localStream);
    var analyser = ac.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    var data = new Uint8Array(analyser.frequencyBinCount);
    var fill = document.getElementById('volFill');
    function tick() {
      analyser.getByteFrequencyData(data);
      var sum = 0;
      for (var i = 0; i < data.length; i++) sum += data[i];
      var avg = sum / data.length;
      fill.style.width = Math.min(avg * 2, 100) + '%';
      requestAnimationFrame(tick);
    }
    tick();
  } catch(e) {}
}

// ── Boost audio bitrate to 128 kbps ─────────────────────────────────
function applyAudioQuality(pc) {
  try {
    var senders = pc.getSenders();
    for (var i = 0; i < senders.length; i++) {
      if (senders[i].track && senders[i].track.kind === 'audio') {
        var params = senders[i].getParameters();
        if (!params.encodings || !params.encodings.length) params.encodings = [{}];
        params.encodings[0].maxBitrate = 128000;
        senders[i].setParameters(params).catch(function(){});
        break;
      }
    }
  } catch(e) {}
}

// ── Boost video bitrate for screen share ────────────────────────────
function applyScreenQuality(pc) {
  try {
    var senders = pc.getSenders();
    for (var i = 0; i < senders.length; i++) {
      if (senders[i].track && senders[i].track.kind === 'video') {
        var params = senders[i].getParameters();
        if (!params.encodings || !params.encodings.length) params.encodings = [{}];
        params.encodings[0].maxBitrate = 8000000;
        params.encodings[0].maxFramerate = 30;
        senders[i].setParameters(params).catch(function(){});
        break;
      }
    }
  } catch(e) {}
}

// ── Make a call ──────────────────────────────────────────────────────
function callFriend() {
  var friendId = document.getElementById('friendId').value.trim().toUpperCase();
  if (!friendId || friendId.length < 4) { sysMsg('Enter your friend\'s Room ID first'); return; }
  if (!localStream) { sysMsg('Microphone not ready yet'); return; }

  sysMsg('Calling ' + friendId + '...');
  setStatus('connecting', 'calling...');

  currentCall = peer.call(friendId, localStream);
  handleCallStream(currentCall);
  showHangUp();

  dataConn = peer.connect(friendId);
  setupDataConn(dataConn);
}

function handleCallStream(call) {
  call.on('stream', function(remoteStream) {
    setRemoteStream(remoteStream);
    setStatus('connected', 'connected');
    sysMsg('Connected!');
    setTimeout(function() { applyAudioQuality(call.peerConnection); }, 500);
  });

  // Catch tracks added later (screen share renegotiation)
  call.peerConnection.ontrack = function(e) {
    if (e.streams && e.streams[0]) setRemoteStream(e.streams[0]);
  };

  // Renegotiation: fires when WE add/remove tracks
  call.peerConnection.onnegotiationneeded = function() {
    if (!isNegotiating) return;
    call.peerConnection.createOffer().then(function(offer) {
      return call.peerConnection.setLocalDescription(offer);
    }).then(function() {
      sendSignal({ type: 'renego-offer', sdp: call.peerConnection.localDescription });
    }).catch(function(e) { console.error('Renegotiation error:', e); });
  };

  call.on('close', function() {
    setStatus('ready', 'ready');
    sysMsg('Call ended');
    document.getElementById('remoteVideo').srcObject = null;
    document.getElementById('remotePlaceholder').style.display = 'flex';
    document.getElementById('hangBtn').style.display = 'none';
  });

  call.on('error', function(e) { sysMsg('Call error: ' + e); });
}

function setRemoteStream(stream) {
  var vid = document.getElementById('remoteVideo');
  if (vid.srcObject === stream) return;
  vid.srcObject = stream;
  document.getElementById('remotePlaceholder').style.display = 'none';
}

// ── Signaling over data channel ──────────────────────────────────────
function sendSignal(payload) {
  if (dataConn && dataConn.open) {
    payload.__signal = true;
    dataConn.send(JSON.stringify(payload));
  }
}

function handleSignal(payload) {
  if (!currentCall) return;
  var pc = currentCall.peerConnection;
  if (payload.type === 'renego-offer') {
    pc.setRemoteDescription(new RTCSessionDescription(payload.sdp)).then(function() {
      return pc.createAnswer();
    }).then(function(answer) {
      return pc.setLocalDescription(answer);
    }).then(function() {
      sendSignal({ type: 'renego-answer', sdp: pc.localDescription });
      setTimeout(function() { applyAudioQuality(pc); applyScreenQuality(pc); }, 500);
    }).catch(function(e) { console.error('Signal error:', e); });
  } else if (payload.type === 'renego-answer') {
    pc.setRemoteDescription(new RTCSessionDescription(payload.sdp)).then(function() {
      setTimeout(function() { applyAudioQuality(pc); applyScreenQuality(pc); }, 500);
    }).catch(function(e) { console.error('Signal error:', e); });
  } else if (payload.type === 'screen-stopped') {
    sysMsg('Friend stopped screen share');
    var vid = document.getElementById('remoteVideo');
    if (vid.srcObject) {
      var vt = vid.srcObject.getVideoTracks();
      for (var i = 0; i < vt.length; i++) vt[i].stop();
      if (!vid.srcObject.getAudioTracks().length) {
        vid.srcObject = null;
        document.getElementById('remotePlaceholder').style.display = 'flex';
      }
    }
  }
}

// ── Data / Chat ──────────────────────────────────────────────────────
function setupDataConn(conn) {
  conn.on('open', function() { sysMsg('Chat connected'); });
  conn.on('data', function(raw) {
    try {
      var parsed = JSON.parse(raw);
      if (parsed.__signal) { handleSignal(parsed); return; }
    } catch(e) {}
    appendMsg('Friend', raw, 'them');
  });
  conn.on('close', function() { sysMsg('Chat disconnected'); });
  conn.on('error', function(e) { console.error(e); });
}

function sendMsg() {
  var input = document.getElementById('chatInput');
  var msg = input.value.trim();
  if (!msg) return;
  if (!dataConn || dataConn.open !== true) { sysMsg('Chat not connected yet'); return; }
  dataConn.send(msg);
  appendMsg('You', msg, 'me');
  input.value = '';
}

function appendMsg(name, text, type) {
  var chat = document.getElementById('chatMessages');
  var div = document.createElement('div');
  div.className = 'msg ' + type;
  var nameHtml = (type !== 'system' && type !== 'me') ? '<div class="msg-name">' + name + '</div>' : '';
  div.innerHTML = nameHtml + '<div class="msg-bubble">' + escHtml(String(text)) + '</div>';
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function sysMsg(text) { appendMsg('', text, 'system'); }

// ── Mute ─────────────────────────────────────────────────────────────
function toggleMute() {
  isMuted = !isMuted;
  if (localStream) {
    var tracks = localStream.getAudioTracks();
    for (var i = 0; i < tracks.length; i++) tracks[i].enabled = !isMuted;
  }
  if (micGainNode) micGainNode.gain.value = isMuted ? 0 : 1;
  var btn = document.getElementById('muteBtn');
  btn.textContent = isMuted ? 'Unmute' : 'Mute';
  btn.classList.toggle('muted', isMuted);
}

// ── Screen Share with audio mixing ────────────────────────────────────
function toggleScreen() {
  if (isScreenSharing) {
    stopScreen();
    return;
  }
  startScreen();
}

function stopScreen() {
  isNegotiating = true;
  if (screenStream) {
    var tracks = screenStream.getTracks();
    for (var i = 0; i < tracks.length; i++) tracks[i].stop();
  }
  if (audioCtx) { audioCtx.close().catch(function(){}); audioCtx = null; mixerDest = null; micGainNode = null; }
  screenStream = null;
  isScreenSharing = false;

  document.getElementById('localVideo').srcObject = localStream;
  document.getElementById('localPlaceholder').style.display = 'flex';
  document.getElementById('screenBtn').textContent = 'Screen';
  document.getElementById('screenBtn').classList.remove('active');

  if (currentCall) {
    var pc = currentCall.peerConnection;
    var senders = pc.getSenders();
    for (var i = 0; i < senders.length; i++) {
      if (senders[i].track && senders[i].track.kind === 'video') pc.removeTrack(senders[i]);
    }
    // Restore plain mic on audio sender
    var micTrack = localStream.getAudioTracks()[0];
    var audioSender = null;
    var s2 = pc.getSenders();
    for (var j = 0; j < s2.length; j++) {
      if (s2[j].track && s2[j].track.kind === 'audio') { audioSender = s2[j]; break; }
    }
    if (audioSender && micTrack) audioSender.replaceTrack(micTrack).catch(function(){});

    pc.createOffer().then(function(offer) {
      return pc.setLocalDescription(offer);
    }).then(function() {
      sendSignal({ type: 'renego-offer', sdp: pc.localDescription });
    }).catch(function(e) { console.error(e); });
  }

  sendSignal({ type: 'screen-stopped' });
  isNegotiating = false;
}

function startScreen() {
  navigator.mediaDevices.getDisplayMedia({
    video: {
      width:     { ideal: 3840, max: 3840 },
      height:    { ideal: 2160, max: 2160 },
      frameRate: { ideal: 30, max: 60 },
      cursor: 'always'
    },
    audio: {
      echoCancellation: false,
      noiseSuppression: false,
      sampleRate: 48000
    }
  }).then(function(stream) {
    screenStream = stream;
    var videoTrack = stream.getVideoTracks()[0];

    // Build audio mixer: mic + system audio → one combined track
    audioCtx = new AudioContext({ sampleRate: 48000 });
    mixerDest = audioCtx.createMediaStreamDestination();

    var micSource = audioCtx.createMediaStreamSource(localStream);
    micGainNode = audioCtx.createGain();
    micGainNode.gain.value = isMuted ? 0 : 1;
    micSource.connect(micGainNode);
    micGainNode.connect(mixerDest);

    var sysTracks = stream.getAudioTracks();
    if (sysTracks.length > 0) {
      var sysSource = audioCtx.createMediaStreamSource(new MediaStream(sysTracks));
      var sysGain = audioCtx.createGain();
      sysGain.gain.value = 1;
      sysSource.connect(sysGain);
      sysGain.connect(mixerDest);
      sysMsg('System audio captured — friend hears your screen audio too');
    } else {
      sysMsg('No system audio detected — tick "Share audio" in the browser dialog next time');
    }

    var mixedAudioTrack = mixerDest.stream.getAudioTracks()[0];

    document.getElementById('localVideo').srcObject = stream;
    document.getElementById('localPlaceholder').style.display = 'none';
    isScreenSharing = true;
    document.getElementById('screenBtn').textContent = 'Stop';
    document.getElementById('screenBtn').classList.add('active');
    sysMsg('Screen sharing started — friend can see your screen');

    if (currentCall) {
      isNegotiating = true;
      var pc = currentCall.peerConnection;

      // Replace mic with mixed audio (no renegotiation needed)
      var senders = pc.getSenders();
      var audioSender = null;
      for (var i = 0; i < senders.length; i++) {
        if (senders[i].track && senders[i].track.kind === 'audio') { audioSender = senders[i]; break; }
      }
      if (audioSender) {
        audioSender.replaceTrack(mixedAudioTrack).catch(function(){});
      } else {
        pc.addTrack(mixedAudioTrack, mixerDest.stream);
      }

      // Add video — triggers onnegotiationneeded → offer → friend gets video
      pc.addTrack(videoTrack, stream);
    }

    videoTrack.onended = function() { if (isScreenSharing) stopScreen(); };

  }).catch(function(e) {
    sysMsg('Screen share failed: ' + e.message);
    if (audioCtx) { audioCtx.close().catch(function(){}); audioCtx = null; }
  });
}

// ── Hang up ──────────────────────────────────────────────────────────
function hangUp() {
  if (isScreenSharing) stopScreen();
  if (currentCall) { currentCall.close(); currentCall = null; }
  if (dataConn)   { dataConn.close(); dataConn = null; }
  document.getElementById('hangBtn').style.display = 'none';
  setStatus('ready', 'ready');
  sysMsg('You hung up');
}

// ── Fullscreen on double-click ────────────────────────────────────────
var wrappers = document.querySelectorAll('.video-wrapper');
for (var w = 0; w < wrappers.length; w++) {
  wrappers[w].addEventListener('dblclick', (function(wrapper) {
    return function() {
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        wrapper.requestFullscreen().catch(function() {
          wrapper.querySelector('video').requestFullscreen().catch(function(){});
        });
      }
    };
  })(wrappers[w]));
}

// ── Helpers ──────────────────────────────────────────────────────────
function copyRoomId() {
  var id = document.getElementById('myIdDisplay').textContent;
  if (id === '——') return;
  navigator.clipboard.writeText(id).then(function() {
    var btn = document.getElementById('copyBtn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(function() { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function setStatus(cls, text) {
  var pill = document.getElementById('statusPill');
  pill.className = 'status-pill ' + cls;
  pill.textContent = text;
}

function showHangUp() {
  document.getElementById('hangBtn').style.display = 'flex';
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Boot ─────────────────────────────────────────────────────────────
initPeer();
</script>
</body>
</html>
